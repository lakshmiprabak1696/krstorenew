# This is a sample build configuration for Docker.
# Check our guides at https://confluence.atlassian.com/x/O1toN for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: atlassian/default-image:2

pipelines:
  default:
    - step:
        services:
          - docker
        name: Build - Push - Deploy to GCP (gcr.io/YourGoogleProject/YourCloudRunServiceName) for Production
        image: google/cloud-sdk:latest
        deployment: production
        script:
        # set CLOUDSDK_CONFIG environment variables
        # - export CLOUDSDK_CONFIG=`pwd`/credentials/service-account.json
        # - gcloud config list

        # set image name
        - export IMAGE_NAME=gcr.io/iamretailer-281612/iar/krstoreprd:1.0.0 # ex. gcr.io/my-g-project/my-cr-service 
        - export SERVICE_NAME=krstore

        # Build image
        - docker build -t $IMAGE_NAME .

        # Gcloud auth and check
        - echo $KEY_FILE_IAR | base64 -d > ./gcloud-api-key.json
        #- gcloud auth activate-service-account --key-file gcloud-api-key.json
        - gcloud auth activate-service-account bbpipeline@iamretailer-281612.iam.gserviceaccount.com --key-file=./gcloud-api-key.json
        #- gcloud auth activate-service-account --key-file=/tmp/key-file.json
        - gcloud config list

        # config image registry with gcloud helper
        - gcloud auth configure-docker -q

        # push image to gcr
        - docker push $IMAGE_NAME

        # deploy to cloud run
        #- gcloud beta run deploy $SERVICE_NAME --image $IMAGE_NAME --region us-central1 --project oerp-zen
        - gcloud run deploy $SERVICE_NAME --image=$IMAGE_NAME --platform=managed --port=80 --set-env-vars=[DB_HOST1='localhost;unix_socket=/cloudsql/stutzenme:us-central1:sz-mysql-5-7',DB_DATABASE1='ssodev_db',DB_USERNAME1='ssodev_db',DB_PASSWORD1='c7Kp6m7',CACHE_DRIVER1='redis',SESSION_DRIVER1='redis',REDIS_HOST1='10.240.0.5',REDIS_PASSWORD1='null',REDIS_PORT1='32768',REDIS_CACHE_DB1='0'] --allow-unauthenticated --service-account=bbpipeline@iamretailer-281612.iam.gserviceaccount.com --add-cloudsql-instances=iamretailer-281612:us-central1:ayyapan --region=us-central1 --project=iamretailer-281612

                    # :-)
                    #- echo "May the force be with you."

